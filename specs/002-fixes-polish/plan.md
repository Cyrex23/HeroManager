# Implementation Plan: Core Game Fixes & Polish

**Branch**: `002-fixes-polish` | **Date**: 2026-02-11 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/002-fixes-polish/spec.md`

## Summary

Fix 5 bugs (team page load failure, missing bench heroes, empty shop abilities dropdown, missing starter hero, confusing email confirmation message) and add 2 enhancements (login online status, hexagonal stat diagram). The bugs share interconnected root causes: backend null safety/transaction issues and a React StrictMode double-effect in the confirmation flow. The enhancements are independent additions to the auth service and a new SVG component.

## Technical Context

**Language/Version**: Java 17+ (backend), TypeScript 5.3 (frontend)
**Primary Dependencies**: Spring Boot 3.2.2, React 18.2, Vite 5, Axios, Lombok
**Storage**: H2 embedded (file-based, dev profile)
**Testing**: Manual only (per project constitution)
**Target Platform**: Web application (localhost dev)
**Project Type**: Web (separate backend + frontend)
**Performance Goals**: N/A (bug fixes + UI component)
**Constraints**: No external charting libraries (YAGNI per constitution)
**Scale/Scope**: 9 hero templates, 10 items, 36 abilities, single-player dev testing

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Functionality-First | PASS | Bug fixes restore core functionality. Hex diagram delivers user-visible feature. |
| II. API-Driven Architecture | PASS | All changes go through existing REST API layer. One endpoint behavior change (confirm → idempotent). |
| III. Layered Backend Structure | PASS | Fixes stay within existing Controller → Service → Repository layers. |
| IV. Component-Based Frontend | PASS | New HexStatDiagram is a reusable component. Confirmation fix is in existing page. |
| V. Pragmatic Quality | PASS | No automated tests added. Fixes are targeted and minimal. |

**Post-Phase 1 Re-check**: PASS — no new patterns, no new dependencies, no schema changes.

## Project Structure

### Documentation (this feature)

```text
specs/002-fixes-polish/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Bug root cause analysis + feature research
├── data-model.md        # Entity behavior changes (no schema changes)
├── quickstart.md        # Verification steps
├── contracts/           # API contract changes
│   ├── auth-api-changes.md
│   └── player-api-fixes.md
└── tasks.md             # Task list (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
backend/
├── src/main/java/com/heromanager/
│   ├── controller/
│   │   └── AuthController.java        # Modified: idempotent confirm response
│   ├── service/
│   │   ├── AuthService.java           # Modified: idempotent confirm, login online status
│   │   ├── PlayerService.java         # Modified: @Transactional, null safety
│   │   └── TeamService.java           # Modified: @Transactional, null safety
│   └── dto/
│       └── HeroResponse.java          # Modified: @JsonProperty for isEquipped

frontend/
├── src/
│   ├── components/
│   │   └── Hero/
│   │       └── HexStatDiagram.tsx     # NEW: SVG hexagonal radar chart
│   ├── pages/
│   │   ├── ConfirmPage.tsx            # Modified: useRef guard, handle alreadyConfirmed
│   │   ├── TeamPage.tsx               # Modified: better error logging
│   │   ├── ShopPage.tsx               # Modified: integrate HexStatDiagram
│   │   └── HeroDetailPage.tsx         # Modified: integrate HexStatDiagram
│   └── components/
│       └── Shop/
│           └── ShopHeroCard.tsx        # Modified: integrate HexStatDiagram
```

**Structure Decision**: Existing web application structure (backend/ + frontend/). No new directories beyond `Hero/HexStatDiagram.tsx`.

## Implementation Phases

### Phase A: Backend Bug Fixes (P1 — US1, US2, US3, US4)

**Goal**: Fix all backend issues causing team page failure and confirmation confusion.

1. **PlayerService.java**: Add `@Transactional(readOnly = true)` to `getHeroes()` and `getSummons()`. Add null check on `hero.getTemplate()` / `summon.getTemplate()` — skip entries with missing templates.

2. **TeamService.java**: Add `@Transactional(readOnly = true)` to `getTeamLineup()`. Add null checks on template access.

3. **HeroResponse.java**: Add `@JsonProperty("isEquipped")` to the `isEquipped` field to prevent Jackson boolean serialization name mangling.

4. **AuthService.java**: Make `confirm()` idempotent — when `confirmedAt` is already set, check if player is confirmed and return success instead of throwing error. Return a flag indicating whether this was a new confirmation or already confirmed.

5. **AuthController.java**: Update confirm endpoint to return the `alreadyConfirmed` flag in response.

### Phase B: Frontend Bug Fixes (P1 — US1, US3, US4)

**Goal**: Fix confirmation double-call and improve error handling.

1. **ConfirmPage.tsx**: Add `useRef` guard to prevent double API calls from React StrictMode. Handle `alreadyConfirmed` response — show "already confirmed" as a success-like state (green text, login link) not an error.

2. **TeamPage.tsx**: Add console error logging in catch block to aid debugging. Consider splitting the three API calls to show partial data if only one fails.

### Phase C: Login Online Status (P2 — US5)

**Goal**: Grant 20 minutes of online status on login after 3+ hours of inactivity.

1. **AuthService.java**: In `login()`, after password validation, check `player.getOnlineUntil()`. If null or more than 3 hours in the past, set `onlineUntil = now + 20 minutes` and save.

### Phase D: Hexagonal Stat Diagram (P2 — US6)

**Goal**: Add SVG radar chart component for hero stats.

1. **HexStatDiagram.tsx**: New component. Props: `stats` (6 base values), `growthStats` (6 growth rates), `size` (diameter), `maxValue` (default 40). Renders SVG with:
   - Hexagonal frame (gray guidelines)
   - Filled polygon (semi-transparent gold)
   - Stat labels at each vertex with value and growth rate

2. **ShopHeroCard.tsx**: Replace or supplement existing stat list with HexStatDiagram (compact, 180px).

3. **HeroDetailPage.tsx**: Add HexStatDiagram (full size, 240px) to hero stats section.

## Complexity Tracking

No constitution violations. All changes use existing patterns and stay within the established architecture.
